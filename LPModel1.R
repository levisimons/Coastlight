#Quick script for plotting variance measures of sky brightness for poster.
require(dplyr)
require(plyr)
require(ggplot2)
require(relaimpo)
require(matrixStats)
require(Hmisc)
require(corrplot)
require("PerformanceAnalytics")
require(ggmap)
require(maps)
require(mapview)
require(mapdata)
require(munsell)
require(leaflet)
require(devtools)
require(webshot)

wd <- "~/Desktop/Coastlight"
setwd(wd)

#Read in data generated by SQC batch analysis.
SQCData <- read.table("CoastlightSkyVariance103Sites.csv", header=TRUE, sep=",",as.is=T,skip=0,fill=TRUE,check.names=FALSE, encoding = "UTF-8")
SQCData <- arrange(SQCData,`SQC File Name`)

#Calculate whole sky coefficient of variation in scalar illuminance
SkySectors <- (SQCData[grepl("D(.*?)R(.*?)Luminance", names(SQCData))])
SectorNames <- colnames(SkySectors)
SkySectors[SkySectors<0] <- NA
SkySectors<-transform(as.matrix(SkySectors),SDLuminance=rowSds(as.matrix(SkySectors),na.rm=TRUE)) 
SkySectors$MeanLuminance <- rowMeans(SkySectors[SectorNames],na.rm=TRUE)
SkySectors$CoVLuminance <- SkySectors$SDLuminance/SkySectors$MeanLuminance
SkySectors$`SQC File Name` <- SQCData$`SQC File Name`
#Merge in these scalar illuminance statistics into the batch analyses data set.
SQCData <- left_join(SQCData,SkySectors[,c("SQC File Name","MeanLuminance","SDLuminance","CoVLuminance")],by=c("SQC File Name"))

#Read in 2012 VIIRS upwards radiance data per site.
VIIRS <- read.table("LPPointsUnder150.csv", header=TRUE, sep=",",as.is=T,skip=0,fill=TRUE,check.names=FALSE)
VIIRS[,'Latitude'] = round(VIIRS[,'Latitude'],5)
VIIRS[,'Longitude'] = round(VIIRS[,'Longitude'],5)

#Read in field data.
FieldData <- read.table("CoastlightFieldData.csv", header=TRUE, sep=",",as.is=T,skip=0,fill=TRUE,check.names=FALSE)
FieldData[,'Centroid latitude'] = round(FieldData[,'Centroid latitude'],5)
FieldData[,'Centroid longitude'] = round(FieldData[,'Centroid longitude'],5)

#Merge in VIIRS data by pixel to field data.
FieldData <- left_join(FieldData,VIIRS[,c("Latitude","Longitude","Brightness (nW/Sr/cm^2)","OBJECTID")],by=c("Centroid latitude" = "Latitude","Centroid longitude" = "Longitude"))
#write.table(FieldData,"CoastligthFieldData.tsv",quote=FALSE,sep="\t",row.names = FALSE)

#Create unique site ID.  Each site contains 5 locations.
colnames(FieldData)[which(names(FieldData) == "OBJECTID")] <- "UniqueID"
FieldData$UniqueID <- as.factor(as.character(FieldData$UniqueID))

#Keep batch analysis data for images with zero horizon.
SQCDataZeroHorizon <- SQCData[!grepl("Horizon",SQCData$'SQC File Name'),]
SQCDataZeroHorizon <- arrange(SQCDataZeroHorizon,`SQC File Name`)

#Keep batch analysis data for images with edited horizon.
SQCDataEditedHorizon <- SQCData[grepl("Horizon",SQCData$'SQC File Name'),]
SQCDataEditedHorizon <- arrange(SQCDataEditedHorizon,`SQC File Name`)

#Zero-horizon merged data set
FieldSQCMergeZH <- left_join(FieldData,SQCDataZeroHorizon,by=c("SQCSiteName"="Location"))
#Edited-horizon merged data set
FieldSQCMergeEH <- left_join(FieldData,SQCDataEditedHorizon,by=c("SQCSiteName"="Location"))
#Determine the fraction of horizon radiance to full sky radiance.
FieldSQCMergeZH$HorizonLuminanceFraction <- (FieldSQCMergeZH$`Scalar Illuminance` - FieldSQCMergeEH$`Scalar Illuminance`) / FieldSQCMergeZH$`Scalar Illuminance`
FieldSQCMergeEH$HorizonLuminanceFraction <- (FieldSQCMergeZH$`Scalar Illuminance` - FieldSQCMergeEH$`Scalar Illuminance`) / FieldSQCMergeZH$`Scalar Illuminance`

#Subset horizon-edited data for analysis of spatial variability of scalar illuminance.
SpatialEH <- FieldSQCMergeEH
SpatialEH <- SpatialEH[,c("UniqueID","Scalar Illuminance")]
SpatialEH <- arrange(SpatialEH,UniqueID)
#Determine the mean of scalar illuminance by UniqueID
tmp <- as.data.frame(aggregate(SpatialEH$`Scalar Illuminance`,by=list(SpatialEH$UniqueID),FUN=mean))
colnames(tmp) <- c("UniqueID","ScalarIlluminanceSiteMean")
SpatialEH <- merge(SpatialEH,tmp,by=c("UniqueID"))
#Determine the coefficient of variation of scalar illuminance by UniqueID
tmp <- as.data.frame(aggregate(SpatialEH$`Scalar Illuminance`,by=list(SpatialEH$UniqueID),FUN=function(ScalarIlluminance){sd(ScalarIlluminance)/mean(ScalarIlluminance)}))
colnames(tmp) <- c("UniqueID","ScalarIlluminanceSiteCoV")
SpatialEH <- merge(SpatialEH,tmp,by=c("UniqueID"))
#Merge into larger data set.
FieldSQCMergeEH <- left_join(FieldSQCMergeEH,SpatialEH,by=c("UniqueID"))

#Subset zero horizon data for analysis of spatial variability of scalar illuminance.
SpatialZH <- FieldSQCMergeZH
SpatialZH <- SpatialZH[,c("UniqueID","Scalar Illuminance")]
SpatialZH <- arrange(SpatialZH,UniqueID)
#Determine the mean of scalar illuminance by UniqueID
tmp <- as.data.frame(aggregate(SpatialZH$`Scalar Illuminance`,by=list(SpatialZH$UniqueID),FUN=mean))
colnames(tmp) <- c("UniqueID","ScalarIlluminanceSiteMean")
SpatialZH <- merge(SpatialZH,tmp,by=c("UniqueID"))
#Determine the coefficient of variation of scalar illuminance by UniqueID
tmp <- as.data.frame(aggregate(SpatialZH$`Scalar Illuminance`,by=list(SpatialZH$UniqueID),FUN=function(ScalarIlluminance){sd(ScalarIlluminance)/mean(ScalarIlluminance)}))
colnames(tmp) <- c("UniqueID","ScalarIlluminanceSiteCoV")
SpatialZH <- merge(SpatialZH,tmp,by=c("UniqueID"))
#Merge into larger data set.
FieldSQCMergeZH <- left_join(FieldSQCMergeZH,SpatialZH,by=c("UniqueID"))

#Full merged data set
FieldSQCMergeEH$TypeHorizon <- "EditedHorizon"
FieldSQCMergeZH$TypeHorizon <- "ZeroHorizon"
FieldSQCMerge <- rbind(FieldSQCMergeZH,FieldSQCMergeEH)

#Plot data for zero-horizon images
LPPlotZH <- ggplot(FieldSQCMergeZH, aes(x=`Brightness (nW/Sr/cm^2)`,y=log10(`Scalar Illuminance`),color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotZH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("Log(Scalar Illuminance (mlx)")+ggtitle("Log of Scalar Illuminance (Field data) vs. VIIRS Upwards Radiance (nW/Sr/cm^2)\nZero Horizon (103 Sites)")+scale_color_gradientn("% Cloud cover",colours = rainbow(5))
#
LPPlotZH <- ggplot(FieldSQCMergeZH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=log10(`Scalar Illuminance`),color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotZH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("Log(Scalar Illuminance (mlx)")+ggtitle("Log of Scalar Illuminance (Field data) vs. 2015 Sky Atlas (mcd/m^2)\nZero Horizon (103 Sites)")+scale_color_gradientn("% Cloud cover",colours = rainbow(5))
#
SQMPlotZH <- ggplot(FieldSQCMergeZH, aes(x=`Brightness (nW/Sr/cm^2)`,y=SQMMean,color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=SQMMean))
SQMPlotZH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("Mean SQM (mag, Field data)")+ggtitle("Mean SQM (mag, Field data) vs. VIIRS Upwards Radiance (nW/Sr/cm^2)\nZero Horizon (103 Sites)")+scale_color_gradientn("% Cloud cover",colours = rainbow(5))

#Plot data for horizon-edited images
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`Brightness (nW/Sr/cm^2)`,y=log10(`Scalar Illuminance`),color=Horizon))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. SQM Atlas (Satellite data)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Horizon",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`Brightness (nW/Sr/cm^2)`,y=log10(`Scalar Illuminance`),color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. SQM Atlas (Satellite data)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Cloud cover",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`Brightness (nW/Sr/cm^2)`,y=log10(`Scalar Illuminance`),color=CoVLuminance))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. SQM Atlas (Satellite data)\nEdited Horizon (103 Sites)")+scale_color_gradientn("CoV Illuminance",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=log10(`Scalar Illuminance`),color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Cloud cover",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=log10(`Scalar Illuminance`),color=Horizon))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Horizon",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=log10(`Scalar Illuminance`),color=CoVLuminance))+geom_point()+geom_smooth(method=glm, aes(fill=`Scalar Illuminance`))
LPPlotEH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("Log(Scalar Illuminance (mlx))")+ggtitle("Log of Scalar Illuminance (Field data) vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("CoV Luminance",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=ScalarIlluminanceSiteCoV,color=Horizon))+geom_point()+geom_smooth(method=glm, aes(fill=ScalarIlluminanceSiteCoV))
LPPlotEH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("CoV Scalar Illuminance within sites")+ggtitle("CoV Scalar Illuminance within sites vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Horizon",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`SQM2015Atlas (mcd/m^2)`,y=ScalarIlluminanceSiteCoV,color=Clouds))+geom_point()+geom_smooth(method=glm, aes(fill=ScalarIlluminanceSiteCoV))
LPPlotEH+xlab("2015 Sky Atlas (mcd/m^2)")+ylab("CoV Scalar Illuminance within sites")+ggtitle("CoV Scalar Illuminance within sites vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Clouds",colours = rainbow(5))
#
LPPlotEH <- ggplot(FieldSQCMergeEH, aes(x=`Brightness (nW/Sr/cm^2)`,y=ScalarIlluminanceSiteCoV,color=Horizon))+geom_point()+geom_smooth(method=glm, aes(fill=ScalarIlluminanceSiteCoV))
LPPlotEH+xlab("VIIRS Upwards Radiance (nW/Sr/cm^2)")+ylab("CoV Scalar Illuminance within sites")+ggtitle("VIIRS Upwards Radiance (nW/Sr/cm^2) vs. 2015 Sky Atlas (mcd/m^2)\nEdited Horizon (103 Sites)")+scale_color_gradientn("% Horizon",colours = rainbow(5))
#

#Fit a model to predict the log of the scalar illuminance from field data for horizon-edited images.
LPModelEH <- lm(log10(`Scalar Illuminance`)~Horizon+Clouds+`SQM2015Atlas (mcd/m^2)`+`Brightness (nW/Sr/cm^2)`,data=FieldSQCMergeEH)
summary(LPModelEH)
printCoefmat(coef(summary(step(LPModelEH))))
calc.relimp(LPModelEH)

#Fit a model to predict the log of the scalar illuminance from field data for zero-horizon images.
LPModelZH <- lm(log10(`Scalar Illuminance`)~Horizon+Clouds+`SQM2015Atlas (mcd/m^2)`+`Brightness (nW/Sr/cm^2)`,data=FieldSQCMergeZH)
summary(LPModelZH)
printCoefmat(coef(summary(step(LPModelZH))))
calc.relimp(LPModelZH)

##Correlations of variance light pollution variables.
#Each significance level is associated to a symbol : p-values(0, 0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)
chart.Correlation(FieldSQCMergeZH[,c("Scalar Illuminance","SDLuminance","SQM2015Atlas (mcd/m^2)","Brightness (nW/Sr/cm^2)","Clouds","Horizon","HorizonLuminanceFraction")], histogram=FALSE, method="spearman")
chart.Correlation(FieldSQCMergeEH[,c("Scalar Illuminance","SDLuminance","SQM2015Atlas (mcd/m^2)","Brightness (nW/Sr/cm^2)","Clouds","Horizon","HorizonLuminanceFraction")], histogram=FALSE, method="spearman")

#To map various measures of coastal light pollution.
MapCoordinates <- FieldSQCMergeEH
colnames(MapCoordinates)[which(names(MapCoordinates) == "Latitude")] <- "SQCLatitude"
colnames(MapCoordinates)[which(names(MapCoordinates) == "Longitude")] <- "SQCLongitude"
colnames(MapCoordinates)[which(names(MapCoordinates) == "Adjusted latitude")] <- "latitude"
colnames(MapCoordinates)[which(names(MapCoordinates) == "Adjusted longitude")] <- "longitude"
MapCoordinates <- MapCoordinates[!is.na(MapCoordinates$latitude) & !is.na(MapCoordinates$longitude),]
CalMap = leaflet(MapCoordinates) %>% 
  addTiles()
ColorScale <- colorNumeric(palette=rainbow(10),domain=log10(MapCoordinates$`Brightness (nW/Sr/cm^2)`+0.001))
CalMap %>% addCircleMarkers(color = ~ColorScale(log10(`Brightness (nW/Sr/cm^2)`+0.001)), fill = TRUE,radius=2,fillOpacity = 0.1) %>% 
  addProviderTiles(providers$Esri.WorldTopoMap) %>%
  leaflet::addLegend(position="topright", pal=ColorScale,values=~log10(`Brightness (nW/Sr/cm^2)`+0.001),title="Log VIIRS Brightness (nW/Sr/cm^2)")
